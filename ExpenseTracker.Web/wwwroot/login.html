
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Expense Tracker — Login / Register</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <main style="max-width:420px;margin:60px auto;">

        <!-- LOGIN PANEL -->
        <section id="login-panel" class="panel">
            <h2>Sign in</h2>
            <form id="form-login">
                <label>
                    Username
                    <input id="login-username" type="text" required />
                </label>
                <label>
                    Password
                    <input id="login-password" type="password" required />
                </label>
                <button type="submit">Sign in</button>
                <div id="login-msg" class="muted"></div>

                <p style="margin-top:18px;" class="muted">
                    Don’t have an account?
                    <span id="goto-register" class="toggle-link">Create one</span>
                </p>
            </form>
        </section>

        <!-- REGISTER PANEL -->
        <section id="register-panel" class="panel hidden">
            <h2>Create Account</h2>

            <form id="form-register">
                <label>
                    Username
                    <input id="reg-name" type="text" required />
                </label>

                <label>
                    Email
                    <input id="reg-email" type="email" required />
                </label>

                <label>
                    Password
                    <input id="reg-password" type="password" required />
                </label>

                <!--<label>
                    RoleId
                    <input id="reg-role" type="number" required />
                </label>

                <label>
                    Parent ID
                    <input id="reg-parent" type="number" required />
                </label>-->

                <button type="submit">Register</button>

                <div id="register-msg"></div>

                <p style="margin-top:18px;" class="muted">
                    Already have an account?
                    <span id="goto-login" class="toggle-link">Sign in</span>
                </p>
            </form>
        </section>


    </main>

    <script>
        (function () {
            const byId = id => document.getElementById(id);
            const show = id => byId(id).classList.remove('hidden');
            const hide = id => byId(id).classList.add('hidden');
            const setMsg = (id, text, err = false) => {
                const el = byId(id);
                el.textContent = text;
                el.className = err ? 'error' : 'muted';
            };

            const LOGIN_URL = '/api/auth/Login';
            const REGISTER_URL = '/api/auth/register'; 

            // Minimal JWT decoder (no verification) — for convenience
            const decodeJwt = (token) => {
                try {
                    const parts = token.split('.');
                    if (parts.length < 2) return null;
                    const base64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                    const json = decodeURIComponent(atob(base64).split('').map(function (c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(json);
                } catch (e) {
                    return null;
                }
            };

            // toggle
            byId('goto-register').onclick = () => {
                hide('login-panel');
                show('register-panel');
            };
            byId('goto-login').onclick = () => {
                hide('register-panel');
                show('login-panel');
            };

            // ====== LOGIN ======
            byId('form-login').addEventListener('submit', async (e) => {
                e.preventDefault();
                setMsg('login-msg', 'Signing in...');

                const username = byId('login-username').value.trim();
                const password = byId('login-password').value;

                if (!username || !password) {
                    setMsg('login-msg', 'Username and password are required.', true);
                    return;
                }

                try {
                    // Call your AuthController.Login
                    const res = await fetch(LOGIN_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });

                    if (!res.ok) {
                        const text = await res.text();
                        // Try to extract message if server returns JSON
                        let msg = 'Incorrect Password!';
                        try {
                            const maybeJson = JSON.parse(text);
                            msg = maybeJson.message || maybeJson.error || msg;
                        } catch (_) {
                            msg = text || msg;
                        }
                        setMsg('login-msg', msg, true);
                        return;
                    }

                    let token;
                    const contentType = res.headers.get('Content-Type') || '';
                    if (contentType.includes('application/json')) {
                        const data = await res.json();
                        token = data.token || data; // support Ok(new { token }) or Ok("token")
                    } else {
                        token = (await res.text()).trim();
                    }
                    console.log("token", token);
                    if (!token || typeof token !== 'string' || token.length < 20) {
                        setMsg('login-msg', 'Invalid token received from server.', true);
                        return;
                    }

                    // Store and redirect
                    localStorage.setItem('jwt', token);

                    const decoded = decodeJwt(token);
                    if (decoded) {
                        localStorage.setItem('currentUser', JSON.stringify(decoded));
                    } else {
                        // optional: clear or store minimal info
                        localStorage.removeItem('currentUser');
                    }

                    // Go to dashboard
                    location.href = '/dashboard.html';

                } catch (err) {
                    setMsg('login-msg', err.message || String(err), true);
                }
            });

            byId('form-register').addEventListener('submit', async (e) => {
                e.preventDefault();
                setMsg('register-msg', 'Creating account...');

                const payload = {
                    username: byId('reg-name').value.trim(),
                    email: byId('reg-email').value.trim(),
                    password: byId('reg-password').value,
                    //roleId: Number(byId('reg-role').value),
                    //parentUserId: byId('reg-parent').value
                    //    ? Number(byId('reg-parent').value)
                    //    : null
                };

                if (!payload.username || !payload.email || !payload.password) {
                    setMsg('register-msg', 'All fields are required.', true);
                    return;
                }

                try {
                    const res = await fetch(REGISTER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', "Authorization": "Bearer "},
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const txt = await res.text();
                        console.log(txt);
                        throw new Error('Registration failed!');
                    }

                    setMsg('register-msg', 'Account created! Please sign in.');
                    hide('register-panel');
                    show('login-panel');
                } catch (err) {
                    setMsg('register-msg', err.message || String(err), true);
                }
            });
        })();
    </script>
</body>
</html>
